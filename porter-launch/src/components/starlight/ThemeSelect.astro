---
const { labels } = Astro.props;
---

<starlight-theme-select>
  <span class="sr-only">{labels["themeSelect.accessibleLabel"]}</span>
  <div class="theme-toggle" role="group" aria-label={labels["themeSelect.accessibleLabel"]}>
    <button type="button" data-theme="light" aria-label={labels["themeSelect.light"]} title={labels["themeSelect.light"]}>
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <circle cx="12" cy="12" r="4" />
        <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.9 4.9l2.2 2.2M16.9 16.9l2.2 2.2M19.1 4.9l-2.2 2.2M7.1 16.9l-2.2 2.2" />
      </svg>
    </button>
    <button type="button" data-theme="dark" aria-label={labels["themeSelect.dark"]} title={labels["themeSelect.dark"]}>
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M20 14.8A8.5 8.5 0 1 1 9.2 4a7 7 0 1 0 10.8 10.8Z" />
      </svg>
    </button>
    <button type="button" data-theme="auto" aria-label={labels["themeSelect.auto"]} title={labels["themeSelect.auto"]}>
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M4 5h16a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1Zm0 11h16v2H4z" />
      </svg>
    </button>
  </div>
</starlight-theme-select>

<script>
  type Theme = "auto" | "dark" | "light";

  const storageKey = "starlight-theme";

  const parseTheme = (theme: unknown): Theme =>
    theme === "auto" || theme === "dark" || theme === "light" ? theme : "auto";

  const loadTheme = (): Theme =>
    parseTheme(typeof localStorage !== "undefined" && localStorage.getItem(storageKey));

  function storeTheme(theme: Theme): void {
    if (typeof localStorage !== "undefined") {
      localStorage.setItem(storageKey, theme === "light" || theme === "dark" ? theme : "");
    }
  }

  const getPreferredColorScheme = (): Theme =>
    matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";

  function renderTheme(theme: Theme): void {
    document.querySelectorAll("starlight-theme-select").forEach((picker) => {
      picker.setAttribute("data-theme", theme);
    });
  }

  function applyTheme(theme: Theme): void {
    document.documentElement.dataset.theme = theme === "auto" ? getPreferredColorScheme() : theme;
    storeTheme(theme);
    renderTheme(theme);
  }

  matchMedia("(prefers-color-scheme: light)").addEventListener("change", () => {
    if (loadTheme() === "auto") applyTheme("auto");
  });

  class StarlightThemeSelect extends HTMLElement {
    constructor() {
      super();

      const currentTheme = loadTheme();
      applyTheme(currentTheme);

      this.querySelectorAll<HTMLButtonElement>("button[data-theme]").forEach((button) => {
        button.addEventListener("click", () => {
          const nextTheme = parseTheme(button.dataset.theme);
          applyTheme(nextTheme);
        });
      });
    }
  }

  if (!customElements.get("starlight-theme-select")) {
    customElements.define("starlight-theme-select", StarlightThemeSelect);
  }
</script>

<style>
  .theme-toggle {
    display: inline-grid;
    grid-template-columns: repeat(3, auto);
    gap: 0.2rem;
    padding: 0.2rem;
    border-radius: 999px;
    border: 1px solid color-mix(in oklab, var(--sl-color-accent) 22%, var(--sl-color-hairline));
    background: color-mix(in oklab, var(--sl-color-bg-nav) 95%, var(--sl-color-accent-low));
  }

  button {
    border: 1px solid transparent;
    border-radius: 999px;
    width: 2rem;
    height: 2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    color: var(--sl-color-gray-2);
    cursor: pointer;
    transition: all 0.18s ease;
  }

  svg {
    width: 1rem;
    height: 1rem;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.9;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  button[data-theme="auto"] svg {
    fill: currentColor;
    stroke: none;
  }

  button:hover {
    color: var(--sl-color-white);
  }

  starlight-theme-select[data-theme="light"] button[data-theme="light"],
  starlight-theme-select[data-theme="dark"] button[data-theme="dark"],
  starlight-theme-select[data-theme="auto"] button[data-theme="auto"] {
    color: var(--sl-color-white);
    border-color: color-mix(in oklab, var(--sl-color-accent) 35%, transparent);
    background: linear-gradient(
      90deg,
      color-mix(in oklab, var(--sl-color-accent) 38%, transparent),
      color-mix(in oklab, var(--sl-color-accent) 14%, transparent)
    );
  }

  @media (max-width: 50rem) {
    .theme-toggle {
      width: 100%;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }
</style>
