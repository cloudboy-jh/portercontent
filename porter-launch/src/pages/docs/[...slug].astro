---
import DocsLayout from "../../layouts/DocsLayout.astro";
import Sidebar from "../../components/docs/Sidebar.svelte";
import TableOfContents from "../../components/docs/TableOfContents.svelte";
import Breadcrumbs from "../../components/docs/Breadcrumbs.svelte";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const docs = await getCollection("docs");
  return docs.map((doc) => ({ params: { slug: doc.slug }, props: { doc } }));
}

const { doc } = Astro.props;
const { Content, headings } = await doc.render();
const docs = await getCollection("docs");

const sections = Array.from(
  docs.reduce((map, entry) => {
    const key = entry.data.category;
    if (!map.has(key)) {
      map.set(key, []);
    }
    map.get(key).push({ title: entry.data.title, slug: entry.slug });
    return map;
  }, new Map())
).map(([category, pages]) => ({
  category,
  pages
}));

const breadcrumbs = [
  { label: "Docs", href: "/docs" },
  { label: doc.data.title, href: `/docs/${doc.slug}` }
];
---

<DocsLayout title={`Porter Docs | ${doc.data.title}`}>
  <section class="docs-layout container">
    <Sidebar sections={sections} currentSlug={doc.slug} client:load />
    <article class="content">
      <Breadcrumbs items={breadcrumbs} />
      <h1>{doc.data.title}</h1>
      <p class="lead">{doc.data.description}</p>
      <Content />
    </article>
    <TableOfContents headings={headings} client:load />
  </section>
</DocsLayout>

<style>
  .docs-layout {
    display: grid;
    grid-template-columns: minmax(200px, 240px) minmax(0, 1fr) minmax(160px, 220px);
    gap: 2rem;
    padding: 2.5rem 0 4rem;
  }

  .content {
    min-width: 0;
  }

  .lead {
    color: var(--ink-400);
    margin-bottom: 1.5rem;
  }

  @media (max-width: 960px) {
    .docs-layout {
      grid-template-columns: 1fr;
    }
  }
</style>
